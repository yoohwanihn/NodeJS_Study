# fs (파일 시스템 접근하기)

fs 모듈은 파일 시스템에 접근하는 모듈이다. 파일을 생성하거나 삭제하고, 읽거나 쓸 수 있도록 하고 폴더도 만들거나 지울 수 있도록 한다.
웹 브라우저에서 자바스크립트를 사용할 때는 일부를 제외하고는 파일 시스템 접근이 금지되어 있으므로 노드의 fs 모듈이 낯설 것이다.


## read_write (파일 읽기 쓰기)

fs 모듈을 불러온 뒤 읽거나 수정할 파일의 경로는 현재 파일 기준이 아니라 node 명령어를 실행하는 콘솔 기준으로 지정해주어야 한다.
fs는 기본적으로 콜백 형식의 모듈이므로 실무에서는 프로미스 형식으로 바꿔주는 방법을 주로 사용할 것이다.

## synchronous_asynchronous (동기 메서드와 비동기 메서드)
-> 동기와 비동기 : 백그라운드 작업 완료 확인 여부
-> 블로킹과 논블로킹 : 함수가 바로 return되는지 여부

setTimeout 같은 타이머와 process.nextTick 외에도, 노드는 대부분 메서드를 비동기 방식으로 처리한다. 하지만 몇몇 메서드는 동기 방식으로도 사용할 수 있다. 특히 fs 모듈이 그러한 메서드를 많이 갖고 있다.

비동기 메서드는 백그라운드에 요청만 하고 다음 작업으로 넘어간다. 그리고 백그라운드 작업이 끝나면 다시 메인 스레드에 알리면 메인 스레드는 그제서야 등록된 콜백 함수를 실행한다. 수백 개의 I/O 요청이 들어와도 메인 스레드는 백그라운드에 요청 처리를 위임하며, 그 후로도 얼마든지 요청을 더 받을 수 있다.

동기 메서드는 요청 작업을 완료한 뒤 그 다음 작업을 진행한다. 그렇기에 요청이 수백 개 이상 들어올 때 성능에 문제가 발생한다. 백그라운드가 작업하는 동안 메인 스레드는 아무것도 못하고 대기하고 있어야 하며, 메인 스레드가 일을 하지 않고 노는 시간이 생기므로 비효율적이다. 백그라운드는 fs 작업을 동시에 처리할 수도 있는데, Sync(동기) 메서드를 사용하면 백그라운드조차 동시에 처리할 수 없게 된다. 따라서 프로그램을 처음 실행할 때 초기화 용도로만 사용하는 것을 권장한다.

비동기 방식으로 하되 순서를 유지하고 싶다면 비동기 메서드의 콜백 다음에 함수를 넣으면 된다. 그리고 이 '콜백 지옥'은 Promise나 async/await으로 어느 정도 해결할 수 있다.

## buffer_stream (버퍼와 스트림)

파일을 읽거나 쓰는 방식은 버퍼를 이용하거나 스트림을 이용하는 두 가지 방식이 있다. 버퍼링은 영상을 재생할 수 있을 때까지 데이터를 모으는 동작이고, 스트리밍은 송출 컴퓨터에서 시청하는 컴퓨터로 영상 데이터를 조금씩 전송하는 동작이다. 스트리밍하는 과정에서 버퍼링을 할 수도 있다.

노드의 readFile 메서드를 사용할 때 읽었던 파일도 버퍼 형식으로 출력되었다. 노드는 파일을 읽을 때 메모리에 파일 크기만큼 공간을 마련해두며 파일 데이터를 메모리에 저장한 뒤 사용자가 조작할 수 있도록 한다. 이때 메모리에 저장된 데이터가 버퍼이다.

from(문자열) : 문자열을 버퍼로 바꿀 수 있다. length 속성은 버퍼의 크기를 알려주며, 바이트 단위이다.
toString(버퍼) : 버퍼를 다시 문자열로 바꿀 수 있다. 이때 base64 나 hex를 인수로 넣으면 해당 인코딩으로 변환 가능하다.
concat(배열) : 배열 안에 든 버퍼들을 하나로 합친다.
alloc(바이트) : 빈 버퍼를 생성한다. 바이트를 인수로 넣으면 해당 크기의 버퍼가 생성된다.

readFile 방식의 버퍼가 편리하긴 하지만 문제점도 있다. 용량이 100MB인 파일을 읽을 때 메모리에 100MB의 버퍼를 만들어야 한다. 이 작업을 동시에 열 개 진행하면 1GB에 해당하는 메모리가 사용된다. 서버처럼 몇 명이 이용할지 모르는 환경에서 메모리 문제가 발생할 수 있다. 또한, 모든 내용을 버퍼에 다 쓴 후에야 다음 동작으로 넘어가므로 파일 읽기, 압축, 파일 쓰기 등의 조작을 할 때 매번 전체 용량을 버퍼로 처리해야 다음 단계로 넘어갈 수 있다. 이를 개선하기 위해 버퍼를 1MB로 만든 후 100MB 파일을 100번에 걸쳐 나눠 보내는 스트림 방식이 생겨났다.